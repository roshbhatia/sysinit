# Nix Codebase Audit Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Perform comprehensive audit of Nix configuration codebase to identify and remove dead code and consistency issues.

**Architecture:** Systematic exploration of codebase structure, dead code analysis using Nix tools and grep patterns, consistency checks against documented guidelines, and cleanup actions with validation.

**Tech Stack:** Nix, shell scripts, grep/ripgrep, tree command, nixfmt, shfmt, stylua

---

### Phase 1: Codebase Inventory & Structure Analysis

#### Task 1.1: Create comprehensive file inventory

**Files:**
- Create: `audit/inventory.nix`
- Create: `audit/inventory.lua` 
- Create: `audit/inventory.sh`

**Step 1: Generate Nix file inventory**

```bash
find . -name "*.nix" -type f | sort > audit/inventory.nix
```

**Step 2: Generate Lua file inventory**

```bash
find . -name "*.lua" -type f | sort > audit/inventory.lua
```

**Step 3: Generate shell script inventory**

```bash
find . -name "*.sh" -type f | sort > audit/inventory.sh
```

**Step 4: Commit initial inventory**

```bash
git add audit/
git commit -m "feat: create initial codebase inventory for audit"
```

#### Task 1.2: Analyze module structure

**Files:**
- Modify: `audit/structure-analysis.md`

**Step 1: Map module hierarchy**

```bash
tree modules/ > audit/module-structure.txt
```

**Step 2: Analyze imports in flake.nix**

Read flake.nix and document all inputs and outputs.

**Step 3: Map home-manager vs system modules**

```bash
find modules/home -name "*.nix" | wc -l
find modules/darwin -name "*.nix" | wc -l  
find modules/nixos -name "*.nix" | wc -l
```

**Step 4: Commit structure analysis**

```bash
git add audit/structure-analysis.md
git commit -m "feat: analyze and document module structure"
```

### Phase 2: Dead Code Analysis

#### Task 2.1: Find unused Nix imports

**Files:**
- Create: `audit/unused-imports.nix`

**Step 1: Check for unused imports in values.nix**

Use nix-instantiate to check for undefined variables.

**Step 2: Analyze module imports**

Check which modules are imported but never used.

**Step 3: Find orphaned Nix files**

Files that exist but are not imported anywhere.

**Step 4: Commit unused imports analysis**

```bash
git add audit/unused-imports.nix
git commit -m "feat: identify unused Nix imports and orphaned files"
```

#### Task 2.2: Analyze unused functions and variables

**Files:**
- Create: `audit/unused-functions.nix`

**Step 1: Check for unused local variables**

```bash
grep -r "let.*=" modules/ --include="*.nix"
```

**Step 2: Find unused functions in lib/**

Analyze lib functions that are never called.

**Step 3: Check for dead configuration options**

Options defined in values schema but never used.

**Step 4: Commit unused functions analysis**

```bash
git add audit/unused-functions.nix
git commit -m "feat: identify unused functions and variables"
```

#### Task 2.3: Lua dead code analysis

**Files:**
- Create: `audit/lua-dead-code.md`

**Step 1: Find unused Lua modules**

Check require statements vs actual files.

**Step 2: Analyze unused functions in Lua files**

**Step 3: Check for orphaned Lua files**

**Step 4: Commit Lua analysis**

```bash
git add audit/lua-dead-code.md
git commit -m "feat: analyze Lua dead code and unused modules"
```

### Phase 3: Consistency Checks

#### Task 3.1: Naming convention audit

**Files:**
- Create: `audit/naming-violations.md`

**Step 1: Check Nix file naming (snake_case)**

```bash
find . -name "*.nix" | grep -v "_" | grep "[A-Z]"
```

**Step 2: Check Nix variable naming (camelCase)**

```bash
grep -r "[a-z]_[a-z]" modules/ --include="*.nix"
```

**Step 3: Check Lua naming conventions**

**Step 4: Commit naming audit**

```bash
git add audit/naming-violations.md
git commit -m "feat: audit naming convention violations"
```

#### Task 3.2: Import pattern consistency

**Files:**
- Create: `audit/import-patterns.md`

**Step 1: Check Nix import patterns**

Verify `{ lib }: with lib;` pattern usage.

**Step 2: Analyze Lua require patterns**

**Step 3: Check shell script sourcing patterns**

**Step 4: Commit import analysis**

```bash
git add audit/import-patterns.md
git commit -m "feat: analyze import and require pattern consistency"
```

#### Task 3.3: Code formatting consistency

**Files:**
- Create: `audit/formatting-issues.md`

**Step 1: Check nixfmt compliance**

```bash
task fmt:nix:check
```

**Step 2: Check shfmt compliance**

```bash
task fmt:sh:check
```

**Step 3: Check stylua compliance**

```bash
task fmt:lua:check
```

**Step 4: Commit formatting audit**

```bash
git add audit/formatting-issues.md
git commit -m "feat: audit code formatting consistency"
```

### Phase 4: Cleanup Actions

#### Task 4.1: Remove unused imports

**Files:**
- Modify: `modules/**/*.nix` (selective)

**Step 1: Remove unused Nix imports**

Edit files to remove identified unused imports.

**Step 2: Test build after removal**

```bash
task nix:build
```

**Step 3: Remove unused Lua requires**

**Step 4: Commit cleanup**

```bash
git add -A
git commit -m "feat: remove unused imports and requires"
```

#### Task 4.2: Delete orphaned files

**Files:**
- Delete: `orphaned-files.txt` (list of files to remove)

**Step 1: Create list of files to delete**

**Step 2: Verify files are truly orphaned**

**Step 3: Remove orphaned files**

```bash
rm orphaned-files.txt
```

**Step 4: Commit deletions**

```bash
git add -A
git commit -m "feat: remove orphaned and unused files"
```

#### Task 4.3: Fix naming inconsistencies

**Files:**
- Modify: `modules/**/*.nix` (rename operations)

**Step 1: Rename files to snake_case**

```bash
git mv CamelCase.nix camel_case.nix
```

**Step 2: Update all references to renamed files**

**Step 3: Test build after renames**

```bash
task nix:build
```

**Step 4: Commit naming fixes**

```bash
git add -A
git commit -m "feat: standardize naming conventions"
```

#### Task 4.4: Consolidate duplicate code

**Files:**
- Create: `shared/utilities.nix`

**Step 1: Identify duplicate patterns**

**Step 2: Extract common functions to shared lib**

**Step 3: Update all usages to use shared version**

**Step 4: Commit consolidation**

```bash
git add -A
git commit -m "feat: consolidate duplicate code patterns"
```

### Phase 5: Validation & Documentation

#### Task 5.1: Final validation

**Files:**
- Modify: `audit/final-report.md`

**Step 1: Run full build test**

```bash
task nix:build:all
```

**Step 2: Run all format checks**

```bash
task fmt:all:check
```

**Step 3: Update AGENTS.md if needed**

**Step 4: Commit final validation**

```bash
git add audit/final-report.md
git commit -m "feat: complete codebase audit and validation"
```

#### Task 5.2: Generate audit summary

**Files:**
- Create: `AUDIT_SUMMARY.md`

**Step 1: Document all changes made**

**Step 2: List remaining issues if any**

**Step 3: Create maintenance recommendations**

**Step 4: Final commit**

```bash
git add AUDIT_SUMMARY.md
git commit -m "docs: create audit summary and maintenance guide"
```
