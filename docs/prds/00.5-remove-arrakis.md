# PRD-00.5: Remove Arrakis NixOS Configuration

## Overview

Remove the arrakis NixOS desktop configuration and all related modules, as this host is no longer in use. Clean up the codebase before beginning the composability refactor.

## Problem Statement

The sysinit repository contains:
- arrakis host configuration in `flake/hosts.nix`
- NixOS-specific desktop modules in `modules/nixos/configurations/`
- References to arrakis throughout Taskfile, documentation, and tests
- Unused code that adds maintenance burden

arrakis was an x86_64 NixOS desktop system that is no longer needed. Lima VMs (PRD-03) will provide NixOS environments going forward.

## Proposed Solution

Remove all arrakis-specific configuration, NixOS desktop modules, and references while preserving:
- NixOS module structure for future Lima VMs
- Any shared/reusable NixOS components
- Darwin (macOS) configurations

## Scope

### In Scope
- Remove arrakis from `flake/hosts.nix`
- Remove NixOS desktop-specific modules:
  - `modules/nixos/configurations/audio.nix`
  - `modules/nixos/configurations/desktop.nix`
  - `modules/nixos/configurations/gaming.nix`
  - `modules/nixos/configurations/hardware.nix`
- Clean up arrakis references in documentation
- Update README if needed
- Verify flake still builds without arrakis

### Out of Scope
- Keep `modules/nixos/` directory structure (needed for Lima VMs in PRD-03)
- Keep any NixOS modules that might be useful for VMs
- Don't remove NixOS-related dependencies from flake inputs (might need for VMs)

## Technical Design

### Files to Remove

```bash
# Host configuration
flake/hosts.nix (remove arrakis entry)

# NixOS desktop modules
modules/nixos/configurations/audio.nix
modules/nixos/configurations/desktop.nix
modules/nixos/configurations/gaming.nix
modules/nixos/configurations/hardware.nix
# Maybe: stylix.nix (check if VM-reusable)
```

### Files to Keep

```bash
# Directory structure for future Lima VMs
modules/nixos/
modules/nixos/default.nix
modules/nixos/home-manager.nix

# System-level configs that might be useful for VMs
modules/nixos/configurations/networking.nix (maybe)
modules/nixos/configurations/packages.nix (maybe)
modules/nixos/configurations/security.nix (maybe)
modules/nixos/configurations/system.nix (maybe)
```

### Updated flake/hosts.nix

```nix
common:

{
  lv426 = {
    system = "aarch64-darwin";
    platform = "darwin";
    inherit (common) username;
    values = common.values // {
      darwin.homebrew.additionalPackages.casks = [
        "betterdiscord-installer"
        "discord"
        "steam"
      ];
      theme = {
        colorscheme = "everforest";
        variant = "dark-soft";
      };
      llm.mcp.additionalServers = {
        # ... (unchanged)
      };
    };
  };
  
  # arrakis removed - NixOS VMs will be defined in PRD-03
}
```

## Acceptance Criteria

All criteria must pass for PRD completion.

**File Removal**
- arrakis entry removed from `flake/hosts.nix`
- Desktop-specific NixOS modules removed from `modules/nixos/configurations/`
- `modules/nixos/` directory still exists (empty or minimal)
- No broken imports from removed files

**Build Validation**
- `nix flake check` passes without arrakis
- `task nix:validate` succeeds
- `task nix:build:lv426` succeeds (Darwin still works)
- No errors about missing arrakis configuration
- Flake outputs don't reference arrakis

**Documentation**
- No references to arrakis in README.md
- No references to arrakis in AGENTS.md
- PRD documents updated (already done in previous commit)
- No broken links or examples referencing arrakis

**Regression Prevention**
- lv426 (macOS) still builds successfully
- Darwin configurations untouched
- No Darwin modules accidentally removed
- Flake structure still valid

**Work Repo Compatibility**
- Work sysinit repo still builds: `cd ~/github/work/rbha18_nike/sysinit && task nix:build`
- Work repo uses `sysinit.lib.builders` (must remain exported)
- Work repo follows sysinit inputs (must remain stable)
- Work repo extends with custom modules (extendModules pattern must work)

## Testing Procedure

### Pre-Flight Check

```bash
# Check current state
nix flake show | grep arrakis

# List NixOS modules to remove
ls -la modules/nixos/configurations/

# Backup current state
git tag pre-arrakis-removal
```

### Removal Steps

```bash
# 1. Remove arrakis from hosts.nix
# Edit flake/hosts.nix manually

# 2. Identify NixOS desktop modules
ls modules/nixos/configurations/
# audio.nix - REMOVE (desktop-specific)
# desktop.nix - REMOVE (desktop-specific)
# gaming.nix - REMOVE (desktop-specific)
# hardware.nix - REMOVE (arrakis-specific UUIDs)
# networking.nix - KEEP? (might be useful for VMs)
# packages.nix - KEEP? (might be useful for VMs)
# security.nix - KEEP? (might be useful for VMs)
# stylix.nix - KEEP? (theming might be useful)
# system.nix - KEEP? (base system settings)

# 3. Remove desktop-specific modules
rm modules/nixos/configurations/audio.nix
rm modules/nixos/configurations/desktop.nix
rm modules/nixos/configurations/gaming.nix
rm modules/nixos/configurations/hardware.nix

# 4. Update default.nix if it imports removed files
# Edit modules/nixos/configurations/default.nix
```

### Validation

```bash
# Test flake validity
nix flake check

# Should NOT show arrakis anymore
nix flake show | grep arrakis

# Test Darwin build (personal)
task nix:build:lv426

# Verify no errors
echo $?  # Should be 0

# Test work repo compatibility
cd ~/github/work/rbha18_nike/sysinit
nix flake update sysinit  # Update to latest personal sysinit
task nix:build            # Should still build
cd -
```

### Documentation Check

```bash
# Search for remaining arrakis references
rg -i "arrakis" --type md
# Should only show PRD documents (historical context)

# Check for broken build references
rg "nix:build:arrakis" --type yaml
rg "task.*arrakis" 
```

## Rollback Plan

### If Build Fails

```bash
# Rollback to pre-removal state
git reset --hard pre-arrakis-removal

# Rebuild
task nix:refresh:lv426
```

### If Flake Check Fails

```bash
# Check what's broken
nix flake check --show-trace

# Fix imports in modules/nixos/configurations/default.nix
# Remove any imports of deleted files
```

## Dependencies

**Blocks**: PRD-01 (Profile System)
**Blocked By**: None

This should be done FIRST before starting the profile system refactor. It's a simple cleanup that reduces complexity.

## Implementation Checklist

- [ ] Remove arrakis from `flake/hosts.nix`
- [ ] Remove `modules/nixos/configurations/audio.nix`
- [ ] Remove `modules/nixos/configurations/desktop.nix`
- [ ] Remove `modules/nixos/configurations/gaming.nix`
- [ ] Remove `modules/nixos/configurations/hardware.nix`
- [ ] Update `modules/nixos/configurations/default.nix` to remove deleted imports
- [ ] Test: `nix flake check` passes
- [ ] Test: `task nix:build:lv426` succeeds
- [ ] Test: Work repo builds (`cd ~/github/work/rbha18_nike/sysinit && task nix:build`)
- [ ] Verify: No `arrakis` in `nix flake show`
- [ ] Verify: `sysinit.lib.builders` still exported
- [ ] Check: No broken references in docs
- [ ] Commit with message: "refactor: remove arrakis NixOS configuration"

## Time Estimate

30 minutes - 1 hour

This is a simple cleanup task with low risk.

## Notes

- Keep `modules/nixos/` directory structure for PRD-03 (Lima VMs)
- Some NixOS modules might be reusable for VMs - evaluate on case-by-case basis
- If unsure about a module, keep it and evaluate during PRD-03
- This is purely a cleanup task - no new functionality
- Low risk: only removing unused code
- Can be done in a single commit
