#!/usr/bin/env zsh
# THIS FILE WAS INSTALLED BY SYSINIT. MODIFICATIONS WILL BE OVERWRITTEN UPON UPDATE.
# shellcheck disable=all
# modules/home/configurations/utils/fzf-preview

# Use realpath if available (from fzf-tab), otherwise use the first argument
if [[ -n "$realpath" ]]; then
  target="$realpath"
else
  target="${1/#\~\//$HOME/}"
fi

center=0

# Handle grep-style output with line numbers (file:line or file:line:column)
if [[ "$target" =~ ^(.+):([0-9]+)(:([0-9]+))?\ *$ ]]; then
  target="${match[1]}"
  center="${match[2]}"
fi

# Directory listing
if [[ -d "$target" ]]; then
  eza --color=always --icons=always -1 "$target"
  exit 0
fi

# Exit if file doesn't exist
[[ ! -f "$target" ]] && exit 1

# Image preview
if file --brief --mime -- "$target" | grep -q "image/"; then
  # Get terminal dimensions
  if [[ -n "$FZF_PREVIEW_COLUMNS" && -n "$FZF_PREVIEW_LINES" ]]; then
    dim="${FZF_PREVIEW_COLUMNS}x${FZF_PREVIEW_LINES}"
  else
    dim="$(tput cols)x$(tput lines)"
  fi

  chafa -s "$dim" "$target"
  echo
else
  # Text file preview
  if ((center > 0)); then
    bat --style=numbers --color=always --pager=never --highlight-line="$center" -- "$target"
  else
    bat --style=numbers --color=always --pager=never -- "$target"
  fi
fi

