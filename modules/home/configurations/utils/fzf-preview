#!/usr/bin/env bash
# THIS FILE WAS INSTALLED BY SYSINIT. MODIFICATIONS WILL BE OVERWRITTEN UPON UPDATE.
# shellcheck disable=all
# modules/home/configurations/utils/fzf-preview
if [[ $# -eq 0 || -z "$1" ]]; then
  echo "No file specified for preview"
  exit 0
fi

# Remove potential trailing whitespace, tabs, and newlines
expanded_target="$(printf "%s" "$1" | sed 's/[[:space:]]*$//')"

# Fallback if nothing left
if [[ -z "$expanded_target" ]]; then
  echo "No file specified for preview after expansion"
  exit 0
fi

# Handle possible "filename:line" format
center=0
if [[ "$expanded_target" =~ ^(.+):([0-9]+)$ ]]; then
  target="${BASH_REMATCH[1]}"
  center="${BASH_REMATCH[2]}"
elif [[ "$expanded_target" =~ ^(.+):([0-9]+):[0-9]+$ ]]; then
  target="${BASH_REMATCH[1]}"
  center="${BASH_REMATCH[2]}"
else
  target="$expanded_target"
fi

if [[ ! -e "$target" ]]; then
  echo "File or directory not found: $target"
  exit 0
fi

# Detect file type
type=$(file --brief --dereference --mime -- "$target" 2>/dev/null)

if [[ -d "$target" ]]; then
  eza --color=always --icons=always -1 -a --group-directories-first --git "$target"
elif [[ "$type" =~ image/ ]]; then
  wezterm imgcat "$target"
else
  if [[ $center -gt 0 ]]; then
    bat --style=numbers --color=always --pager=never --highlight-line=$center -- "$target"
  else
    bat --style=numbers --color=always --pager=never -- "$target"
  fi
fi

