#!/usr/bin/env zsh
# modules/home/configurations/utils/dev/fzf-preview
# Purpose: Intelligent file/directory preview for fzf-tab
# Handles files (bat), directories (eza), and images (chafa)

# Debug: uncomment to see what's being passed
# echo "DEBUG: word=[$word] realpath=[$realpath] \$1=[$1]" >&2

# fzf-tab passes the actual completion result as the first positional argument
# The $word and $realpath variables are for context but the actual target is $1
target="${1}"

# If no argument, try the environment variables (fallback for direct invocation)
if [[ -z "$target" ]]; then
  if [[ -n "$realpath" ]]; then
    target="$realpath"
  elif [[ -n "$word" ]]; then
    target="$word"
  fi
fi

# Exit if target is empty or a literal variable reference
if [[ -z "$target" || "$target" == "\$word" || "$target" == "\$realpath" ]]; then
  exit 0
fi

# Expand tilde (~) to home directory
target="${target/#\~/$HOME}"

# Resolve to absolute path if relative
if [[ "$target" != /* ]]; then
  target="$(pwd)/$target"
fi

# Normalize path only if it exists (avoid :A failing on non-existent paths)
if [[ -e "$target" ]]; then
  target="${target:A}"
fi

# Exit silently if target doesn't exist (completion in progress)
if [[ ! -e "$target" ]]; then
  exit 0
fi

# Handle directories
if [[ -d "$target" ]]; then
  if command -v eza &>/dev/null; then
    eza --color=always --icons=always --group-directories-first -1 "$target"
  else
    ls -1 --color=always "$target" 2>/dev/null || ls -1 "$target"
  fi
  exit 0
fi

# Handle regular files
if [[ -f "$target" ]]; then
  # Detect file type using MIME
  mime_type="$(file --brief --mime-type -- "$target" 2>/dev/null)"

  # Handle images
  if [[ "$mime_type" == image/* ]]; then
    if command -v chafa &>/dev/null; then
      if [[ -n "$FZF_PREVIEW_COLUMNS" && -n "$FZF_PREVIEW_LINES" ]]; then
        dim="${FZF_PREVIEW_COLUMNS}x${FZF_PREVIEW_LINES}"
      else
        dim="$(tput cols 2>/dev/null || echo 80)x$(tput lines 2>/dev/null || echo 24)"
      fi
      chafa --size "$dim" "$target" 2>/dev/null
      exit 0
    else
      echo "Image file: $target (install chafa for preview)" >&2
      exit 0
    fi
  fi

  # Handle text/code files with bat
  if command -v bat &>/dev/null; then
    bat --style=numbers --color=always --pager=never -- "$target" 2>/dev/null
  else
    # Fallback to cat with line numbers
    cat -n "$target" 2>/dev/null || cat "$target"
  fi
  exit 0
fi

# Handle other file types (symlinks, devices, etc.)
echo "Special file: $target"
file "$target"
exit 0
