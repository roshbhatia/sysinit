#!/usr/bin/env nu

def main [command?: string] {
    let loglib = ($env.HOME + "/.local/bin/loglib.nu")
    source $loglib

    if (which gh | is-empty) {
        log_error "GitHub CLI not installed"
        exit 1
    }

    def setup_account [account_type: string] {
        let gh_config_dir = $env.HOME + "/.config/gh-" + $account_type
        
        log_info $"Setting up ($account_type) GitHub account..."
        log_info $"This will authenticate using gh CLI with a separate config directory: ($gh_config_dir)"
        
        # Create config directory if it doesn't exist
        mkdir -p $gh_config_dir
        
        # Authenticate with the specified config directory
        let result = (
            with-env { GH_CONFIG_DIR: $gh_config_dir } {
                gh auth login | complete
            }
        )

        if $result.exit_code == 0 {
            log_success $"($account_type) GitHub account authenticated successfully"
            
            # Show the authenticated user
            let user_result = (
                with-env { GH_CONFIG_DIR: $gh_config_dir } {
                    gh api user --jq '.login' 2> /dev/null | complete
                }
            )
            
            if $user_result.exit_code == 0 {
                let username = ($user_result.stdout | str trim)
                log_info $"Authenticated as: ($username)"
            }
        } else {
            log_error $"Failed to authenticate ($account_type) GitHub account"
            return 1
        }
    }

    def show_status [] {
        log_info "Checking authentication status..."
        
        for account_type in ["personal" "work"] {
            let gh_config_dir = $env.HOME + "/.config/gh-" + $account_type
            
            if ($gh_config_dir | path exists) {
                let user_result = (
                    with-env { GH_CONFIG_DIR: $gh_config_dir } {
                        gh api user --jq '.login' 2> /dev/null | complete
                    }
                )
                
                if $user_result.exit_code == 0 {
                    let username = ($user_result.stdout | str trim)
                    log_success $"($account_type): ($username)"
                } else {
                    log_warn $"($account_type): Not authenticated"
                }
            } else {
                log_warn $"($account_type): Config directory not found"
            }
        }
    }

    def print_usage [] {
        print "Usage: gh-auth-setup [command]

Commands:
  personal    Set up personal GitHub account authentication
  work        Set up work GitHub account authentication
  both        Set up both personal and work accounts
  status      Show authentication status for both accounts
  help        Show this help message

Examples:
  gh-auth-setup personal
  gh-auth-setup work
  gh-auth-setup both
  gh-auth-setup status"
    }

    match ($command | default "help") {
        "personal" => { setup_account "personal" }
        "work" => { setup_account "work" }
        "both" => {
            setup_account "personal"
            print ""
            setup_account "work"
        }
        "status" => { show_status }
        "help" | "--help" | "-h" => { print_usage }
        _ => {
            log_error $"Unknown command: ($command)"
            print ""
            print_usage
            exit 1
        }
    }
}
