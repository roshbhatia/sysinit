#!/usr/bin/env zsh
# Converted from core.main/github.sh to standalone executable
# THIS FILE WAS INSTALLED BY SYSINIT. MODIFICATIONS WILL BE OVERWRITTEN UPON UPDATE.
# shellcheck disable=all
function log_warn() {
  echo -e "\033[1;33mWARNING:\033[0m $*" >&2
}

function log_error() {
  echo -e "\033[1;31mERROR:\033[0m $*" >&2
}

function main() {
  if ! command -v goose &> /dev/null; then
    log_error "goose not installed"
    return 1
  fi

  if ! command -v gum &> /dev/null; then
    log_error "gum not installed"
    return 1
  fi

  msg=$(goose run --text "Generate a conventional commit message for my staged changes. ONLY output the commit message, DO NOT print anything else." --no-session 2>/dev/null | tail -1)

  if [[ -z "$msg" ]]; then
    log_warn "No commit message generated by goose"
    return 1
  fi

  edited_msg=$(echo "$msg" | gum write --placeholder="Edit commit message...")
  if [[ -z "$edited_msg" ]]; then
    log_warn "Empty commit message, aborting"
    return 1
  fi

  git commit -m "$edited_msg"
}

main "$@"
