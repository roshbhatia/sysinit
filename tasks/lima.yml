# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  PROJECT_NAME:
    sh: basename "$(pwd)"
  VM_NAME: "{{.PROJECT_NAME}}-dev"

tasks:
  init:
    desc: Initialize Lima VM config for current project
    cmds:
      - nix flake init -t github:roshbhatia/sysinit#vm-dev
      - direnv allow

  shell:
    desc: Connect to project Lima VM (manual)
    cmds:
      - limactl shell "{{.VM_NAME}}"

  start:
    desc: Start project Lima VM without entering
    cmds:
      - limactl start "{{.VM_NAME}}"

  stop:
    desc: Stop project Lima VM
    cmds:
      - limactl stop "{{.VM_NAME}}"

  status:
    desc: Show project Lima VM status
    cmds:
      - limactl list | grep "{{.VM_NAME}}" || echo "VM not found"

  destroy:
    desc: Destroy project Lima VM
    cmds:
      - limactl delete "{{.VM_NAME}}"

  rebuild:
    desc: Rebuild Lima dev image
    cmds:
      - ./hack/build-lima-image lima-dev
