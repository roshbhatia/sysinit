# Ascalon - Persistent NixOS VM
# Full NixOS environment with golden image parity to macOS host

# VM Images - using nixos-lima pre-built images
images:
  - location: "https://github.com/nixos-lima/nixos-lima/releases/download/v0.0.4/nixos-lima-aarch64.qcow2"
    arch: "aarch64"
    digest: "sha512:..."  # Update with actual digest from release

# CPU & Memory
cpus: 6
memory: "12GiB"
disk: "50GiB"

# Architecture
arch: "aarch64"

# Mounts
mounts:
  # Sysinit repository (for nixos-rebuild)
  - location: "~/github/personal/roshbhatia/sysinit"
    writable: true
    9p:
      securityModel: mapped-xattr
      cache: "mmap"
  
  # Docker socket from Colima
  - location: "~/.colima/default/docker.sock"
    writable: true
  
  # 1Password agent socket
  - location: "~/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
    writable: true

# SSH
ssh:
  localPort: 0  # Automatically assign port
  loadDotSSHPubKeys: true  # Load ~/.ssh/*.pub keys
  forwardAgent: true

# Port forwarding via lima-guestagent (vsock)
portForwards:
  - guestSocket: "/run/user/{{.UID}}/wezterm/wezterm.sock"
    hostSocket: "{{.Dir}}/wezterm.sock"

# Provisioning - Apply NixOS configuration on first boot
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      
      # Wait for network
      until ping -c1 nixos.org &>/dev/null; do
        echo "Waiting for network..."
        sleep 1
      done
      
      # Create dev user if not exists (lima-init should handle this)
      if ! id -u dev &>/dev/null; then
        useradd -m -G wheel -s /bin/bash dev
        echo "dev ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/dev
      fi
      
      # Clone sysinit if not mounted (failsafe)
      if [ ! -d /home/dev/sysinit ]; then
        mkdir -p /home/dev
        ln -sf /mnt/sysinit /home/dev/sysinit || true
      fi
      
      # Apply NixOS configuration
      cd /home/dev/sysinit
      nixos-rebuild boot --flake .#ascalon
      
      echo "Ascalon provisioned successfully. Reboot to activate configuration."

# Firmware
firmware:
  legacyBIOS: false  # Use EFI

# Host resolver
hostResolver:
  enabled: true
  hosts:
    host.lima.internal: host.lima.internal

# Timezone
timezone: "America/New_York"

# Auto-start on macOS boot
autostart: true

# Rosetta (for x86 compatibility if needed)
rosetta:
  enabled: false  # Disable for now, enable if needed for specific tools

# Video display (headless)
video:
  display: none

# Audio (disabled for headless VM)
audio:
  device: none

# Network
networks:
  - lima: shared  # Shared network with host
