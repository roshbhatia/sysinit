#!/usr/bin/env bash
set -euo pipefail

log_error() { echo -e "\033[1;31m[ERROR]\033[0m $*" >&2; }
log_success() { echo -e "\033[0;32m[OK]\033[0m $*"; }

if [ "$(id -u)" -eq 0 ] && [ -z "${SUDO_USER:-}" ]; then
  log_error "Git operations should not run as root"
  exit 1
fi

check_command() { command -v "$1" >/dev/null 2>&1; }

for cmd in "task" "nixfmt" "stylua" "deadnix" "statix" "nix"; do
  if ! check_command "$cmd"; then
    echo "Skipping hooks: $cmd not found"
    exit 0
  fi
done

files_modified=0
staged_nix_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.nix$' || true)

# Validate flake evaluates (critical - blocks commit)
# Only check darwin on macOS, nixos on Linux
echo -n "Validating nix flake... "
if [[ "$(uname)" == "Darwin" ]]; then
  if ! nix build .#darwinConfigurations.lv426.system --dry-run 2>/dev/null; then
    log_error "Darwin config failed - fix errors before committing"
    exit 1
  fi
else
  if ! nix build .#nixosConfigurations.arrakis.config.system.build.toplevel --dry-run 2>/dev/null; then
    log_error "NixOS config failed - fix errors before committing"
    exit 1
  fi
fi
log_success "flake valid"

# Dead code removal
if [ -n "$staged_nix_files" ]; then
  echo -n "Removing dead nix code... "
  while IFS= read -r file; do
    [ -f "$file" ] && deadnix --edit "$file" 2>/dev/null || true
  done <<<"$staged_nix_files"
  if ! git diff --quiet --exit-code -- $staged_nix_files 2>/dev/null; then
    files_modified=1
  fi
  log_success "done"
fi

# Formatting
echo -n "Formatting... "
task fmt sh:chmod >/dev/null 2>&1
staged_files=$(git diff --cached --name-only --diff-filter=ACM)
if [ -n "$staged_files" ]; then
  for file in $staged_files; do
    if [ -f "$file" ] && ! git diff --quiet -- "$file" 2>/dev/null; then
      files_modified=1
      break
    fi
  done
fi
log_success "done"

# Docs regeneration
echo -n "Updating docs... "
task docs:values >/dev/null 2>&1
if ! git diff --quiet README.md 2>/dev/null; then
  files_modified=1
fi
log_success "done"

# Root-owned files check
root_files=$(find . -path ./.git -prune -o -user root -print 2>/dev/null || true)
if [ -n "$root_files" ]; then
  log_error "Found root-owned files - run: sudo chown -R \$USER:\$(id -gn) ."
  exit 1
fi

# Re-stage if needed
if [ "$files_modified" -eq 1 ]; then
  git add -u
  log_success "Pre-commit complete (files reformatted)"
else
  log_success "Pre-commit complete"
fi
