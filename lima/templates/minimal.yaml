vmType: "vz"
os: "Linux"
arch: "aarch64"

cpus: 2
memory: "4GiB"
disk: "20GiB"

# Use official NixOS cloud image
# Custom images can be built later with nixos-generators
images:
  - location: "https://channels.nixos.org/nixos-unstable/latest-nixos-minimal-aarch64-linux.iso"
    arch: "aarch64"

mounts:
  - location: "~/.ssh"
    writable: false
  - location: "~/projects"
    writable: true
    9p:
      securityModel: "none"
      cache: "mmap"

ssh:
  localPort: 0
  loadDotSSHPubKeys: true

provision:
  - mode: system
    script: |
      #!/bin/sh
      set -eux
      echo "Lima NixOS VM provisioned"
      uname -a

probes:
  - description: "SSH is ready"
    script: |
      #!/bin/bash
      ssh -o ConnectTimeout=3 127.0.0.1 true
    hint: "Waiting for SSH to be ready..."
